--https://platform.stratascratch.com/coding/10352-users-by-avg-session-time?code_type=1
-- max(page_load - page_exit) by day , page_load < page_exit 

with cte as(
select 
user_id,
DATE(timestamp) as date,
max(case when action ='page_load' then timestamp end) as page_load_time, -- latest login time 
min(case when action ='page_exit' then timestamp end) as page_exit_time -- earliest exit time
from facebook_web_log
group by user_id,DATE(timestamp)
)

-- select * from cte;
,session as(select
user_id,
-- date,
page_exit_time - page_load_time as session_duration
from cte
where page_load_time < page_exit_time --filters invalid rows
and page_load_time is not null --NULL sessions could affect your average (AVG) if not handled carefully.
and page_exit_time is not null
)

select
user_id,
avg(session_duration) as avg_session_duration
from session
group by user_id


another solution 


WITH loads AS (
  SELECT
    user_id,
    DATE(timestamp) AS day,
    MAX(timestamp) AS load_time
  FROM facebook_web_log
  WHERE action = 'page_load'
  GROUP BY user_id, DATE(timestamp)
),
exits AS (
  SELECT
    user_id,
    DATE(timestamp) AS day,
    MIN(timestamp) AS exit_time
  FROM facebook_web_log
  WHERE action = 'page_exit'
  GROUP BY user_id, DATE(timestamp)
),
sessions AS (
  SELECT
    l.user_id,
    l.load_time,
    e.exit_time,
    EXTRACT(EPOCH FROM (e.exit_time - l.load_time)) AS session_duration
  FROM loads l
  JOIN exits e
    ON l.user_id = e.user_id AND l.day = e.day
  WHERE l.load_time < e.exit_time
)
SELECT
  user_id,
  AVG(session_duration) AS avg_session_duration
FROM sessions
GROUP BY user_id;

EPOCH = number of seconds between two timestamps.
EXTRACT(EPOCH FROM ...) is very handy when you want numeric session duration instead of an interval type.


AVG(session_duration)/60 AS avg_session_minutes -- to convert to miute

